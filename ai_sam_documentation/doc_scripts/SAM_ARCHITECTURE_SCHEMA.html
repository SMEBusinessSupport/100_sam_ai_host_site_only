<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAM AI Architecture Schema</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-hover: #1f3460;
            --accent-blue: #4a9eff;
            --accent-green: #4ade80;
            --accent-purple: #a78bfa;
            --accent-orange: #fb923c;
            --accent-pink: #f472b6;
            --accent-cyan: #22d3ee;
            --accent-yellow: #facc15;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, var(--bg-card), #1e3a5f);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .updated {
            font-size: 0.85rem;
            color: var(--accent-green);
            margin-top: 10px;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .tab:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }

        .tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Content Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Flow Diagram */
        .flow-diagram {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .flow-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flow-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent-blue);
            border-radius: 2px;
        }

        .flow-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: var(--bg-dark);
            border-radius: 10px;
            border-left: 3px solid var(--accent-blue);
            transition: all 0.3s ease;
        }

        .flow-step:hover {
            transform: translateX(5px);
            border-left-color: var(--accent-green);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-file {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--accent-cyan);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .step-arrow {
            color: var(--accent-orange);
            font-size: 1.5rem;
            margin-left: auto;
        }

        /* Component Grid */
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .component-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .component-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .component-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .component-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .component-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .component-model {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-purple);
            background: rgba(167, 139, 250, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        .component-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .component-connections {
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .connection-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .connection-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .connection-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: monospace;
        }

        .connection-tag.calls {
            background: rgba(74, 158, 255, 0.15);
            color: var(--accent-blue);
        }

        .connection-tag.called-by {
            background: rgba(74, 222, 128, 0.15);
            color: var(--accent-green);
        }

        .connection-tag.stores {
            background: rgba(251, 146, 60, 0.15);
            color: var(--accent-orange);
        }

        /* Layer colors */
        .layer-frontend { background: rgba(244, 114, 182, 0.2); }
        .layer-controller { background: rgba(74, 158, 255, 0.2); }
        .layer-service { background: rgba(74, 222, 128, 0.2); }
        .layer-model { background: rgba(167, 139, 250, 0.2); }
        .layer-external { background: rgba(251, 146, 60, 0.2); }

        /* Data Flow Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-hover);
            font-weight: 600;
            color: var(--accent-blue);
        }

        .data-table tr:hover {
            background: var(--bg-hover);
        }

        .data-table code {
            font-family: monospace;
            background: rgba(74, 158, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* ASCII Diagram */
        .ascii-diagram {
            background: #0d1117;
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre;
            color: #c9d1d9;
            border: 1px solid var(--border-color);
        }

        .ascii-diagram .highlight-blue { color: var(--accent-blue); }
        .ascii-diagram .highlight-green { color: var(--accent-green); }
        .ascii-diagram .highlight-purple { color: var(--accent-purple); }
        .ascii-diagram .highlight-orange { color: var(--accent-orange); }
        .ascii-diagram .highlight-pink { color: var(--accent-pink); }
        .ascii-diagram .highlight-cyan { color: var(--accent-cyan); }
        .ascii-diagram .highlight-yellow { color: var(--accent-yellow); }

        /* Method list */
        .method-list {
            margin-top: 10px;
        }

        .method-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .method-name {
            font-family: monospace;
            color: var(--accent-cyan);
        }

        .method-desc {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .component-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SAM AI Architecture Schema</h1>
            <p>How every component connects and communicates in the SAM AI ecosystem</p>
            <div class="updated">Last Updated: December 16, 2025 | Phases 1-16 (ML Layer In Progress) | Services Layer Updated</div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="showSection('overview')">Overview</div>
            <div class="tab" onclick="showSection('chat-flow')">Chat Message Flow</div>
            <div class="tab" onclick="showSection('streaming')">Streaming Architecture</div>
            <div class="tab" onclick="showSection('models')">Data Models</div>
            <div class="tab" onclick="showSection('services')">Services Layer</div>
            <div class="tab" onclick="showSection('providers')">AI Providers</div>
            <div class="tab" onclick="showSection('ml-layer')">ML Layer (Phase 16)</div>
        </div>

        <!-- OVERVIEW SECTION -->
        <div id="overview" class="section active">
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color layer-frontend"></div>
                    <span>Frontend (JS/OWL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color layer-controller"></div>
                    <span>Controllers (HTTP)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color layer-service"></div>
                    <span>Services (Business Logic)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color layer-model"></div>
                    <span>Models (Database)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color layer-external"></div>
                    <span>External (AI APIs)</span>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">High-Level Architecture</div>
                <div class="ascii-diagram">
<span class="highlight-pink">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-pink">â”‚                              FRONTEND LAYER                                      â”‚</span>
<span class="highlight-pink">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚</span>
<span class="highlight-pink">â”‚  â”‚  sam_chat.js    â”‚  â”‚ sam_chat.xml    â”‚  â”‚ sam_chat.scss   â”‚                  â”‚</span>
<span class="highlight-pink">â”‚  â”‚  (OWL Component)â”‚  â”‚ (Templates)     â”‚  â”‚ (Styling)       â”‚                  â”‚</span>
<span class="highlight-pink">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚</span>
<span class="highlight-pink">â”‚           â”‚ EventSource (SSE)                                                   â”‚</span>
<span class="highlight-pink">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
            â”‚
            â–¼
<span class="highlight-blue">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-blue">â”‚                             CONTROLLER LAYER                                     â”‚</span>
<span class="highlight-blue">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>
<span class="highlight-blue">â”‚  â”‚  sam_ai_chat_controller.py                                                â”‚   â”‚</span>
<span class="highlight-blue">â”‚  â”‚  â”œâ”€â”€ /sam/stream_message  (POST) â†’ SSE streaming endpoint                â”‚   â”‚</span>
<span class="highlight-blue">â”‚  â”‚  â”œâ”€â”€ /sam/permission_response (POST) â†’ Handle access gate responses      â”‚   â”‚</span>
<span class="highlight-blue">â”‚  â”‚  â””â”€â”€ /sam/modes/* â†’ Mode management endpoints                            â”‚   â”‚</span>
<span class="highlight-blue">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>
<span class="highlight-blue">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
            â”‚
            â–¼
<span class="highlight-green">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-green">â”‚                              SERVICES LAYER                                      â”‚</span>
<span class="highlight-green">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚</span>
<span class="highlight-green">â”‚  â”‚  chat_input.py      â”‚  â”‚  node_input.py      â”‚  â”‚  conversation.py    â”‚      â”‚</span>
<span class="highlight-green">â”‚  â”‚  â”œ gather_context() â”‚  â”‚  (Workflow nodes)   â”‚  â”‚  (History manager)  â”‚      â”‚</span>
<span class="highlight-green">â”‚  â”‚  â”” builds context   â”‚  â”‚                     â”‚  â”‚                     â”‚      â”‚</span>
<span class="highlight-green">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚</span>
<span class="highlight-green">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
              â”‚
              â–¼
<span class="highlight-purple">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-purple">â”‚                               MODELS LAYER                                       â”‚</span>
<span class="highlight-purple">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span>
<span class="highlight-purple">â”‚  â”‚  ai_brain.py (ai.service) - THE BRAIN                                     â”‚  â”‚</span>
<span class="highlight-purple">â”‚  â”‚  â”œâ”€â”€ send_message_streaming()     â†’ Main entry point                      â”‚  â”‚</span>
<span class="highlight-purple">â”‚  â”‚  â”œâ”€â”€ _chat_via_sdk()              â†’ Anthropic SDK streaming               â”‚  â”‚</span>
<span class="highlight-purple">â”‚  â”‚  â”œâ”€â”€ _chat_via_http()             â†’ OpenAI-compatible HTTP streaming      â”‚  â”‚</span>
<span class="highlight-purple">â”‚  â”‚  â””â”€â”€ _chat_via_google()           â†’ Google/Gemini (placeholder)           â”‚  â”‚</span>
<span class="highlight-purple">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span>
<span class="highlight-purple">â”‚                                                                                  â”‚</span>
<span class="highlight-purple">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚</span>
<span class="highlight-purple">â”‚  â”‚ ai.conversation â”‚  â”‚ ai.message      â”‚  â”‚ ai.access.gate  â”‚                  â”‚</span>
<span class="highlight-purple">â”‚  â”‚ (Chat history)  â”‚  â”‚ (Messages)      â”‚  â”‚ (Permissions)   â”‚                  â”‚</span>
<span class="highlight-purple">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚</span>
<span class="highlight-purple">â”‚                                                                                  â”‚</span>
<span class="highlight-purple">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚</span>
<span class="highlight-purple">â”‚  â”‚ api.credentials â”‚  â”‚ api.service.    â”‚  â”‚ ai.token.usage  â”‚                  â”‚</span>
<span class="highlight-purple">â”‚  â”‚ (API keys)      â”‚  â”‚ provider        â”‚  â”‚ (Cost tracking) â”‚                  â”‚</span>
<span class="highlight-purple">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚</span>
<span class="highlight-purple">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
              â”‚
              â–¼
<span class="highlight-orange">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-orange">â”‚                             EXTERNAL AI PROVIDERS                                â”‚</span>
<span class="highlight-orange">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚</span>
<span class="highlight-orange">â”‚  â”‚  Anthropic      â”‚  â”‚  OpenAI         â”‚  â”‚  Groq           â”‚                  â”‚</span>
<span class="highlight-orange">â”‚  â”‚  (via SDK)      â”‚  â”‚  (via HTTP)     â”‚  â”‚  (via HTTP)     â”‚                  â”‚</span>
<span class="highlight-orange">â”‚  â”‚  $$$            â”‚  â”‚  $$             â”‚  â”‚  $              â”‚                  â”‚</span>
<span class="highlight-orange">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚</span>
<span class="highlight-orange">â”‚                                                                                  â”‚</span>
<span class="highlight-orange">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚</span>
<span class="highlight-orange">â”‚  â”‚  Ollama         â”‚  â”‚  Google/Gemini  â”‚                                       â”‚</span>
<span class="highlight-orange">â”‚  â”‚  (LOCAL/FREE)   â”‚  â”‚  (placeholder)  â”‚                                       â”‚</span>
<span class="highlight-orange">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚</span>
<span class="highlight-orange">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Philosophy: SAM = Intelligence, Provider = Language Engine</div>
                <div class="ascii-diagram">
<span class="highlight-cyan">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-cyan">â”‚                         SAM'S VALUE (Your IP)                                    â”‚</span>
<span class="highlight-cyan">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  Business Intelligence    â”‚  Odoo Integration    â”‚  Memory System       â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  Workflow Automation      â”‚  Power Prompts       â”‚  Access Control      â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  Context Building         â”‚  User Profiles       â”‚  Cost Optimization   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span>
<span class="highlight-cyan">â”‚                                                                                  â”‚</span>
<span class="highlight-cyan">â”‚  SAM's characteristics, behavior, and intelligence are CONSISTENT               â”‚</span>
<span class="highlight-cyan">â”‚  regardless of which AI provider is the "language engine"                       â”‚</span>
<span class="highlight-cyan">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="highlight-orange">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-orange">â”‚                      LANGUAGE ENGINE (Replaceable)                               â”‚</span>
<span class="highlight-orange">â”‚                                                                                  â”‚</span>
<span class="highlight-orange">â”‚   Anthropic ($$$)  â†â†’  OpenAI ($$)  â†â†’  Groq ($)  â†â†’  Ollama (FREE)             â”‚</span>
<span class="highlight-orange">â”‚                                                                                  â”‚</span>
<span class="highlight-orange">â”‚   All provide "conversational ability" - SAM provides the INTELLIGENCE          â”‚</span>
<span class="highlight-orange">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                </div>
            </div>
        </div>

        <!-- CHAT FLOW SECTION -->
        <div id="chat-flow" class="section">
            <div class="flow-diagram">
                <div class="flow-title">Complete Chat Message Flow</div>
                <div class="flow-steps">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <strong>User types message and clicks Send</strong>
                            <div class="step-file">ai_sam/static/src/components/sam_chat/sam_chat.js â†’ sendMessage()</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <strong>EventSource opens SSE connection</strong>
                            <div class="step-file">POST /sam/stream_message with {message, conversation_id, context_data}</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <strong>Controller receives request, starts event_stream generator</strong>
                            <div class="step-file">ai_sam_base/controllers/sam_ai_chat_controller.py â†’ send_message_streaming()</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <strong>ChatInput.gather_context() yields activity events</strong>
                            <div class="step-file">ai_sam_base/services/chat_input.py â†’ gather_context()</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <strong>Access Gate checks permission for shared folders</strong>
                            <div class="step-file">ai_sam_base/models/ai_access_gate.py â†’ check_access()</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <strong>THE BRAIN routes to appropriate chat method</strong>
                            <div class="step-file">ai_sam_base/models/ai_brain.py â†’ send_message_streaming()</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">7</div>
                        <div class="step-content">
                            <strong>Chat method streams response (SDK or HTTP)</strong>
                            <div class="step-file">_chat_via_sdk() for Anthropic | _chat_via_http() for OpenAI-compatible</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">8</div>
                        <div class="step-content">
                            <strong>Chunks stream back through controller to frontend</strong>
                            <div class="step-file">event: chunk â†’ Frontend appends to response bubble</div>
                        </div>
                        <div class="step-arrow">â†“</div>
                    </div>
                    <div class="flow-step">
                        <div class="step-number">9</div>
                        <div class="step-content">
                            <strong>Token usage logged, conversation saved</strong>
                            <div class="step-file">ai.token.usage.log_usage() + ai.message.create()</div>
                        </div>
                        <div class="step-arrow">âœ“</div>
                    </div>
                </div>
            </div>

            <!-- Side-by-side Architecture + UX Flow + Tool Flow (3 columns) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <!-- LEFT: Three-Layer Architecture -->
                <div class="flow-diagram">
                    <div class="flow-title">Three-Layer Architecture</div>
                    <div class="ascii-diagram" style="font-size: 0.65rem;">
<span class="highlight-pink">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-pink">â”‚      FRONTEND (ai_sam module)          â”‚</span>
<span class="highlight-pink">â”‚                                        â”‚</span>
<span class="highlight-pink">â”‚  sam_chat_vanilla_v2.js                â”‚</span>
<span class="highlight-pink">â”‚  â”œâ”€â”€ User types message                â”‚</span>
<span class="highlight-pink">â”‚  â”œâ”€â”€ handleSend() â†’ fetch()            â”‚</span>
<span class="highlight-pink">â”‚  â””â”€â”€ Renders streaming response        â”‚</span>
<span class="highlight-pink">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
                    â–¼
<span class="highlight-blue">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-blue">â”‚      CONTROLLER (ai_sam_base)          â”‚</span>
<span class="highlight-blue">â”‚                                        â”‚</span>
<span class="highlight-blue">â”‚  sam_ai_chat_controller.py             â”‚</span>
<span class="highlight-blue">â”‚  â””â”€â”€ unified_stream()                  â”‚</span>
<span class="highlight-blue">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
                    â–¼
<span class="highlight-green">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-green">â”‚         THE THREE LAYERS               â”‚</span>
<span class="highlight-green">â”‚                                        â”‚</span>
<span class="highlight-green">â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span>
<span class="highlight-green">â”‚ â”‚ <span class="highlight-cyan">1ï¸âƒ£ chat_input.py</span>                  â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  BUILDS CONTEXT                    â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  âœ“ gather_context()                â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  âœ“ build_system_prompt()           â”‚ â”‚</span>
<span class="highlight-green">â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span>
<span class="highlight-green">â”‚                  â”‚                     â”‚</span>
<span class="highlight-green">â”‚                  â–¼                     â”‚</span>
<span class="highlight-green">â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span>
<span class="highlight-green">â”‚ â”‚ <span class="highlight-purple">2ï¸âƒ£ ai_brain.py</span> (orchestrator)     â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  COORDINATES AI CALL               â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  âœ“ send_message_streaming()        â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  âœ“ Handles tool use                â”‚ â”‚</span>
<span class="highlight-green">â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span>
<span class="highlight-green">â”‚                  â”‚                     â”‚</span>
<span class="highlight-green">â”‚                  â–¼                     â”‚</span>
<span class="highlight-green">â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span>
<span class="highlight-green">â”‚ â”‚ <span class="highlight-yellow">3ï¸âƒ£ sam_voice.py</span> (kernel)          â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  DEFINES HOW SAM THINKS            â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  âœ“ SAM_TOOLS_V1 definitions        â”‚ â”‚</span>
<span class="highlight-green">â”‚ â”‚  âœ“ format_memory_context()         â”‚ â”‚</span>
<span class="highlight-green">â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span>
<span class="highlight-green">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
                    â–¼
<span class="highlight-orange">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-orange">â”‚         SUPPORTING FILES               â”‚</span>
<span class="highlight-orange">â”‚                                        â”‚</span>
<span class="highlight-orange">â”‚  SAM_AI_PERSONALITY.md (~94 lines)     â”‚</span>
<span class="highlight-orange">â”‚  â””â”€â”€ WHO SAM is (warm, adaptive)       â”‚</span>
<span class="highlight-orange">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    </div>
                </div>

                <!-- CENTER: User Experience Timeline -->
                <div class="flow-diagram">
                    <div class="flow-title">User Experience Timeline</div>
                    <div class="ascii-diagram" style="font-size: 0.65rem;">
<span class="highlight-cyan">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-cyan">â”‚      USER EXPERIENCE TIMELINE          â”‚</span>
<span class="highlight-cyan">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="highlight-cyan">â”‚                                        â”‚</span>
<span class="highlight-cyan">â”‚  User clicks Send                      â”‚</span>
<span class="highlight-cyan">â”‚       â”‚                                â”‚</span>
<span class="highlight-cyan">â”‚       â–¼                                â”‚</span>
<span class="highlight-cyan">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ <span class="highlight-green">chat_input.py: gather_context()</span> â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ ğŸ” Checking access...       â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ ğŸ“‚ Reading folder...        â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ ğŸ“„ Found 15 files...        â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ ğŸ§  Searching memories...    â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â””â”€â”€ ğŸ”§ Building context...      â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span>
<span class="highlight-cyan">â”‚       â”‚                                â”‚</span>
<span class="highlight-cyan">â”‚       â–¼                                â”‚</span>
<span class="highlight-cyan">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ <span class="highlight-purple">ai_brain.py: streaming()</span>        â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ <span class="highlight-yellow">âœ¨ Thinking...</span> (varied)    â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ <span class="highlight-yellow">âœ¨ Composing response...</span>   â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â””â”€â”€ ğŸ’¬ Responding...            â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span>
<span class="highlight-cyan">â”‚       â”‚                                â”‚</span>
<span class="highlight-cyan">â”‚       â–¼                                â”‚</span>
<span class="highlight-cyan">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ <span class="highlight-orange">chat_output.py: format()</span>        â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ Formats for SSE             â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â”œâ”€â”€ Streams chunks              â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â”‚ â””â”€â”€ <span class="highlight-green">âœ… Done</span>                    â”‚  â”‚</span>
<span class="highlight-cyan">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span>
<span class="highlight-cyan">â”‚                                        â”‚</span>
<span class="highlight-cyan">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="highlight-yellow">Activity messages defined in:</span>
<span class="highlight-orange">chat_output.py â†’ ACTIVITY_MESSAGES</span>
                    </div>
                </div>

                <!-- RIGHT: Tool Execution Flow (Phase 17) -->
                <div class="flow-diagram">
                    <div class="flow-title">Tool Execution Flow (Phase 17)</div>
                    <div class="ascii-diagram" style="font-size: 0.65rem;">
<span class="highlight-purple">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-purple">â”‚  User: "What's in D:\MyFolder?"        â”‚</span>
<span class="highlight-purple">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
                    â–¼
<span class="highlight-blue">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-blue">â”‚  AI receives tools from sam_voice.py   â”‚</span>
<span class="highlight-blue">â”‚  (read_file, list_directory, etc.)     â”‚</span>
<span class="highlight-blue">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
                    â–¼
<span class="highlight-cyan">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-cyan">â”‚  AI responds with tool_use:            â”‚</span>
<span class="highlight-cyan">â”‚  list_directory("D:\MyFolder")         â”‚</span>
<span class="highlight-cyan">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
                    â–¼
<span class="highlight-yellow">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-yellow">â”‚  _execute_tool() checks               â”‚</span>
<span class="highlight-yellow">â”‚  ai.access.gate for permission        â”‚</span>
<span class="highlight-yellow">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
<span class="highlight-red">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="highlight-green">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-red">â”‚ NO PERMISSION   â”‚</span>   <span class="highlight-green">â”‚ GRANTED         â”‚</span>
<span class="highlight-red">â”‚                 â”‚</span>   <span class="highlight-green">â”‚                 â”‚</span>
<span class="highlight-red">â”‚ yield           â”‚</span>   <span class="highlight-green">â”‚ Execute tool    â”‚</span>
<span class="highlight-red">â”‚ permission_     â”‚</span>   <span class="highlight-green">â”‚                 â”‚</span>
<span class="highlight-red">â”‚ required        â”‚</span>   <span class="highlight-green">â”‚       â”‚         â”‚</span>
<span class="highlight-red">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>   <span class="highlight-green">â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
         â”‚                     â”‚
         â–¼                     â–¼
<span class="highlight-orange">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="highlight-blue">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-orange">â”‚ Frontend shows  â”‚</span>   <span class="highlight-blue">â”‚ Tool result     â”‚</span>
<span class="highlight-orange">â”‚ permission      â”‚</span>   <span class="highlight-blue">â”‚ sent back to AI â”‚</span>
<span class="highlight-orange">â”‚ popup ğŸ”        â”‚</span>   <span class="highlight-blue">â”‚                 â”‚</span>
<span class="highlight-orange">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>   <span class="highlight-blue">â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
         â”‚                     â”‚
         â–¼                     â–¼
<span class="highlight-green">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="highlight-green">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-green">â”‚ User grants     â”‚</span>   <span class="highlight-green">â”‚ AI responds     â”‚</span>
<span class="highlight-green">â”‚ permission      â”‚</span>   <span class="highlight-green">â”‚ with folder     â”‚</span>
<span class="highlight-green">â”‚ âœ… Allow        â”‚</span>   <span class="highlight-green">â”‚ contents        â”‚</span>
<span class="highlight-green">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>   <span class="highlight-green">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Layer Responsibilities Summary</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>File</th>
                            <th>Responsibility</th>
                            <th>Key Methods</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>1. Input</strong></td>
                            <td><code>chat_input.py</code></td>
                            <td>Builds context, permissions, system prompt</td>
                            <td><code>gather_context()</code>, <code>build_system_prompt()</code></td>
                        </tr>
                        <tr>
                            <td><strong>2. Brain</strong></td>
                            <td><code>ai_brain.py</code></td>
                            <td>Orchestrates API calls, streaming, tool use</td>
                            <td><code>send_message_streaming()</code>, <code>_chat_via_sdk()</code></td>
                        </tr>
                        <tr>
                            <td><strong>3. Voice</strong></td>
                            <td><code>sam_voice.py</code></td>
                            <td>Reasoning framework, tool definitions, memory injection</td>
                            <td><code>get_memory_enhanced_prompt()</code>, <code>SAM_TOOLS_V1</code></td>
                        </tr>
                        <tr>
                            <td><strong>Personality</strong></td>
                            <td><code>SAM_AI_PERSONALITY.md</code></td>
                            <td>WHO SAM is (voice, tone, multi-user awareness)</td>
                            <td>Loaded by <code>chat_input._load_base_prompt()</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">SSE Event Types</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Event Type</th>
                            <th>Purpose</th>
                            <th>Example Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>event: activity</code></td>
                            <td>Progress updates (reading, searching, building)</td>
                            <td><code>{"activity": "reading_folder", "message": "ğŸ“‚ Reading..."}</code></td>
                        </tr>
                        <tr>
                            <td><code>event: status</code></td>
                            <td>Progress percentage updates</td>
                            <td><code>{"status": "Processing...", "progress": 40}</code></td>
                        </tr>
                        <tr>
                            <td><code>event: chunk</code></td>
                            <td>Response text chunks (streaming)</td>
                            <td><code>{"text": "Hello, "}</code></td>
                        </tr>
                        <tr>
                            <td><code>event: permission_required</code></td>
                            <td>Access gate needs approval</td>
                            <td><code>{"permission_request": {id, path, buttons}}</code></td>
                        </tr>
                        <tr>
                            <td><code>event: done</code></td>
                            <td>Completion with metadata</td>
                            <td><code>{"success": true, "conversation_id": 123}</code></td>
                        </tr>
                        <tr>
                            <td><code>event: error</code></td>
                            <td>Error occurred</td>
                            <td><code>{"error": "API timeout"}</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- STREAMING SECTION -->
        <div id="streaming" class="section">
            <div class="flow-diagram">
                <div class="flow-title">Provider-Agnostic Streaming (Phase 14)</div>
                <div class="ascii-diagram">
<span class="highlight-purple">send_message_streaming()</span>
          â”‚
          â”‚ <span class="highlight-yellow">config.api_format</span>
          â”‚
          â”œâ”€â”€â”€â”€ <span class="highlight-blue">'anthropic'</span> â”€â”€â”€â”€â–º <span class="highlight-cyan">_chat_via_sdk()</span>
          â”‚                          â”‚
          â”‚                          â””â”€â”€ Uses Anthropic SDK
          â”‚                              <span class="highlight-green">client.messages.stream()</span>
          â”‚
          â”œâ”€â”€â”€â”€ <span class="highlight-blue">'openai'</span> â”€â”€â”€â”€â”€â”€â–º <span class="highlight-cyan">_chat_via_http()</span>
          â”‚                          â”‚
          â”‚                          â””â”€â”€ Raw HTTP SSE
          â”‚                              Works with: OpenAI, Groq, Ollama,
          â”‚                              Azure, DeepSeek, Together AI, etc.
          â”‚
          â””â”€â”€â”€â”€ <span class="highlight-blue">'google'</span> â”€â”€â”€â”€â”€â”€â–º <span class="highlight-cyan">_chat_via_google()</span>
                                     â”‚
                                     â””â”€â”€ Placeholder (not yet implemented)
                </div>
            </div>

            <div class="component-grid">
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ”Œ</div>
                        <div class="component-name">_chat_via_sdk()</div>
                    </div>
                    <div class="component-desc">
                        Uses official Anthropic SDK for streaming. Best quality, most features, highest cost.
                    </div>
                    <div class="method-list">
                        <div class="method-item">
                            <span class="method-name">anthropic.Anthropic()</span>
                            <span class="method-desc">Initialize SDK client</span>
                        </div>
                        <div class="method-item">
                            <span class="method-name">client.messages.stream()</span>
                            <span class="method-desc">Stream response chunks</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸŒ</div>
                        <div class="component-name">_chat_via_http()</div>
                    </div>
                    <div class="component-desc">
                        Raw HTTP SSE streaming for all OpenAI-compatible APIs. Maximum compatibility, no SDK dependency.
                    </div>
                    <div class="method-list">
                        <div class="method-item">
                            <span class="method-name">requests.post(stream=True)</span>
                            <span class="method-desc">Open streaming connection</span>
                        </div>
                        <div class="method-item">
                            <span class="method-name">response.iter_lines()</span>
                            <span class="method-desc">Parse SSE data lines</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">OpenAI-Compatible HTTP Streaming Flow</div>
                <div class="ascii-diagram">
<span class="highlight-cyan">_chat_via_http(config, system_prompt, messages)</span>
    â”‚
    â”œâ”€â”€ 1. Build OpenAI-format messages
    â”‚       <span class="highlight-green">[{role: 'system', content: ...}, {role: 'user', ...}]</span>
    â”‚
    â”œâ”€â”€ 2. Construct endpoint URL
    â”‚       <span class="highlight-yellow">config.api_endpoint</span> + '/v1/chat/completions'
    â”‚
    â”œâ”€â”€ 3. POST with stream=True
    â”‚       <span class="highlight-orange">requests.post(url, headers, json=payload, stream=True)</span>
    â”‚
    â”œâ”€â”€ 4. Parse SSE stream
    â”‚       for line in response.iter_lines():
    â”‚           if line.startswith('data: '):
    â”‚               <span class="highlight-purple">data = json.loads(line[6:])</span>
    â”‚               content = data['choices'][0]['delta'].get('content')
    â”‚               <span class="highlight-green">yield {'type': 'chunk', 'data': {'text': content}}</span>
    â”‚
    â””â”€â”€ 5. Yield final metadata
            <span class="highlight-blue">yield {'type': 'stream_complete', 'data': {tokens, text}}</span>
                </div>
            </div>
        </div>

        <!-- MODELS SECTION -->
        <div id="models" class="section">
            <div class="flow-diagram">
                <div class="flow-title">Core Data Models</div>
            </div>

            <div class="component-grid">
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ§ </div>
                        <div class="component-name">THE BRAIN</div>
                        <div class="component-model">ai.service</div>
                    </div>
                    <div class="component-desc">
                        Central AI orchestrator. Routes messages, manages streaming, tracks tokens.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Key Methods</div>
                        <div class="method-list">
                            <div class="method-item">
                                <span class="method-name">send_message_streaming()</span>
                                <span class="method-desc">Main entry point</span>
                            </div>
                            <div class="method-item">
                                <span class="method-name">_chat_via_sdk()</span>
                                <span class="method-desc">Anthropic SDK</span>
                            </div>
                            <div class="method-item">
                                <span class="method-name">_chat_via_http()</span>
                                <span class="method-desc">OpenAI HTTP</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ’¬</div>
                        <div class="component-name">Conversation</div>
                        <div class="component-model">ai.conversation</div>
                    </div>
                    <div class="component-desc">
                        Chat history container. Links to context (Odoo records), user, workspace.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Relationships</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">ai.message (O2M)</span>
                            <span class="connection-tag stores">res.users (M2O)</span>
                            <span class="connection-tag stores">ai.workspace (M2O)</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ“</div>
                        <div class="component-name">Message</div>
                        <div class="component-model">ai.message</div>
                    </div>
                    <div class="component-desc">
                        Individual message in conversation. Tracks role, content, tokens, timing.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Fields</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">role (user/assistant)</span>
                            <span class="connection-tag stores">content (text)</span>
                            <span class="connection-tag stores">ai_model</span>
                            <span class="connection-tag stores">token_count</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ”</div>
                        <div class="component-name">Access Gate</div>
                        <div class="component-model">ai.access.gate</div>
                    </div>
                    <div class="component-desc">
                        Permission control for shared folders/files. THE GATEKEEPER.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">States</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">pending</span>
                            <span class="connection-tag stores">approved</span>
                            <span class="connection-tag stores">approved_recursive</span>
                            <span class="connection-tag stores">denied</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ”‘</div>
                        <div class="component-name">API Credentials</div>
                        <div class="component-model">api.credentials</div>
                    </div>
                    <div class="component-desc">
                        Stores API keys for AI providers. Per-user or company-wide.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Relationships</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">api.service.provider</span>
                            <span class="connection-tag stores">res.users</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ¢</div>
                        <div class="component-name">Service Provider</div>
                        <div class="component-model">api.service.provider</div>
                    </div>
                    <div class="component-desc">
                        Provider configuration template. Stores api_format, endpoint, default model.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Key Fields</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">api_format</span>
                            <span class="connection-tag stores">api_endpoint</span>
                            <span class="connection-tag stores">default_model</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ“Š</div>
                        <div class="component-name">Token Usage</div>
                        <div class="component-model">ai.token.usage</div>
                    </div>
                    <div class="component-desc">
                        Tracks token consumption and costs per request.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Tracked</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">input_tokens</span>
                            <span class="connection-tag stores">output_tokens</span>
                            <span class="connection-tag stores">cost_usd</span>
                            <span class="connection-tag stores">response_time_ms</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ‘¤</div>
                        <div class="component-name">User Profile</div>
                        <div class="component-model">sam.user.profile</div>
                    </div>
                    <div class="component-desc">
                        SAM's relationship with each user. Interaction count, preferences.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Features</div>
                        <div class="connection-list">
                            <span class="connection-tag stores">interaction_count</span>
                            <span class="connection-tag stores">first_interaction</span>
                            <span class="connection-tag stores">preferences</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SERVICES SECTION -->
        <div id="services" class="section">
            <div class="flow-diagram">
                <div class="flow-title">Services Layer - Business Logic</div>
            </div>

            <div class="component-grid">
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ“¥</div>
                        <div class="component-name">ChatInput</div>
                    </div>
                    <div class="component-desc">
                        Gathers context for chat messages. Handles folder reading, memory search, context building.
                    </div>
                    <div class="step-file">ai_sam_base/services/chat_input.py</div>
                    <div class="method-list">
                        <div class="method-item">
                            <span class="method-name">gather_context()</span>
                            <span class="method-desc">Generator yielding activity events</span>
                        </div>
                        <div class="method-item">
                            <span class="method-name">_build_environment_context()</span>
                            <span class="method-desc">Build env string for prompt</span>
                        </div>
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Calls</div>
                        <div class="connection-list">
                            <span class="connection-tag calls">ai.access.gate</span>
                            <span class="connection-tag calls">NodeInput</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ”§</div>
                        <div class="component-name">NodeInput</div>
                    </div>
                    <div class="component-desc">
                        Handles workflow node context extraction. Reads folders/files recursively.
                    </div>
                    <div class="step-file">ai_sam_workflows/services/node_input.py</div>
                    <div class="method-list">
                        <div class="method-item">
                            <span class="method-name">extract_folder_context()</span>
                            <span class="method-desc">Read folder contents</span>
                        </div>
                        <div class="method-item">
                            <span class="method-name">build_file_tree()</span>
                            <span class="method-desc">Generate file structure</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ—‚ï¸</div>
                        <div class="component-name">Conversation Service</div>
                    </div>
                    <div class="component-desc">
                        Manages conversation lifecycle. Create, load, archive conversations.
                    </div>
                    <div class="step-file">ai_sam_base/services/conversation.py</div>
                    <div class="component-connections">
                        <div class="connection-label">Works With</div>
                        <div class="connection-list">
                            <span class="connection-tag calls">ai.conversation</span>
                            <span class="connection-tag calls">ai.message</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ“¤</div>
                        <div class="component-name">ChatOutput</div>
                    </div>
                    <div class="component-desc">
                        Handles output formatting and activity messages. Provider-agnostic varied phrases.
                    </div>
                    <div class="step-file">ai_sam_base/services/chat_output.py</div>
                    <div class="method-list">
                        <div class="method-item">
                            <span class="method-name">ACTIVITY_MESSAGES</span>
                            <span class="method-desc">De-branded activity phrases (âœ¨ Thinking...)</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ”Œ</div>
                        <div class="component-name">APIServices</div>
                    </div>
                    <div class="component-desc">
                        API provider abstraction layer. Routes to correct chat method based on api_format.
                    </div>
                    <div class="step-file">ai_sam_base/services/api_services.py</div>
                    <div class="component-connections">
                        <div class="connection-label">Routes To</div>
                        <div class="connection-list">
                            <span class="connection-tag calls">_chat_via_sdk()</span>
                            <span class="connection-tag calls">_chat_via_http()</span>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ§ </div>
                        <div class="component-name">Memory Service</div>
                    </div>
                    <div class="component-desc">
                        Semantic memory search using ChromaDB vectors. Falls back gracefully if unavailable.
                    </div>
                    <div class="step-file">ai_sam_base/services/memory.py</div>
                    <div class="method-list">
                        <div class="method-item">
                            <span class="method-name">search()</span>
                            <span class="method-desc">Find relevant past conversations</span>
                        </div>
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Uses</div>
                        <div class="connection-list">
                            <span class="connection-tag calls">ai.vector.service</span>
                            <span class="connection-tag calls">chromadb (optional)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">gather_context() Activity Flow</div>
                <div class="ascii-diagram">
<span class="highlight-cyan">gather_context(context_data, user_message)</span>
    â”‚
    â”œâ”€â”€ <span class="highlight-yellow">WORKFLOW MODE CHECK</span>
    â”‚   â””â”€â”€ If workflow node context â†’ yield workflow_mode â†’ return
    â”‚
    â”œâ”€â”€ <span class="highlight-green">PHASE 1: ACCESS GATE + FOLDER READING</span>
    â”‚   â”œâ”€â”€ yield <span class="highlight-blue">'checking_access'</span> â†’ ğŸ” Checking access...
    â”‚   â”œâ”€â”€ ai.access.gate.check_access(path)
    â”‚   â”‚   â”œâ”€â”€ needs_approval? â†’ yield <span class="highlight-orange">'permission_required'</span> â†’ STOP
    â”‚   â”‚   â””â”€â”€ denied? â†’ yield <span class="highlight-orange">'access_denied'</span> â†’ STOP
    â”‚   â”œâ”€â”€ yield <span class="highlight-blue">'reading_folder'</span> â†’ ğŸ“‚ Reading folder...
    â”‚   â””â”€â”€ NodeInput.extract_folder_context()
    â”‚       â””â”€â”€ yield <span class="highlight-blue">'counting_files'</span> â†’ ğŸ“„ Found N files...
    â”‚
    â”œâ”€â”€ <span class="highlight-green">PHASE 2: MEMORY SEARCH</span>
    â”‚   â””â”€â”€ yield <span class="highlight-blue">'searching_memory'</span> â†’ ğŸ§  Searching past conversations...
    â”‚
    â”œâ”€â”€ <span class="highlight-green">PHASE 3: CONTEXT BUILDING</span>
    â”‚   â””â”€â”€ yield <span class="highlight-blue">'building_context'</span> â†’ ğŸ”§ Building context...
    â”‚
    â””â”€â”€ <span class="highlight-purple">FINAL: yield 'context_complete' with full context dict</span>
                </div>
            </div>
        </div>

        <!-- PROVIDERS SECTION -->
        <div id="providers" class="section">
            <div class="flow-diagram">
                <div class="flow-title">AI Provider Configuration</div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Provider</th>
                        <th>api_format</th>
                        <th>Chat Method</th>
                        <th>Endpoint</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Anthropic</strong></td>
                        <td><code>anthropic</code></td>
                        <td><code>_chat_via_sdk()</code></td>
                        <td>SDK handles it</td>
                        <td>$$$</td>
                    </tr>
                    <tr>
                        <td><strong>OpenAI</strong></td>
                        <td><code>openai</code></td>
                        <td><code>_chat_via_http()</code></td>
                        <td>https://api.openai.com</td>
                        <td>$$</td>
                    </tr>
                    <tr>
                        <td><strong>Groq</strong></td>
                        <td><code>openai</code></td>
                        <td><code>_chat_via_http()</code></td>
                        <td>https://api.groq.com/openai</td>
                        <td>$</td>
                    </tr>
                    <tr>
                        <td><strong>Ollama</strong></td>
                        <td><code>openai</code></td>
                        <td><code>_chat_via_http()</code></td>
                        <td>http://localhost:11434</td>
                        <td>FREE</td>
                    </tr>
                    <tr>
                        <td><strong>Azure OpenAI</strong></td>
                        <td><code>openai</code></td>
                        <td><code>_chat_via_http()</code></td>
                        <td>Custom Azure endpoint</td>
                        <td>$$</td>
                    </tr>
                    <tr>
                        <td><strong>Google/Gemini</strong></td>
                        <td><code>google</code></td>
                        <td><code>_chat_via_google()</code></td>
                        <td>Not yet implemented</td>
                        <td>TBD</td>
                    </tr>
                </tbody>
            </table>

            <div class="flow-diagram" style="margin-top: 30px;">
                <div class="flow-title">Provider Registration Flow</div>
                <div class="ascii-diagram">
<span class="highlight-cyan">node_metadata.json</span> (Source of truth for vendors)
    â”‚
    â”‚  <span class="highlight-yellow">"groq": {</span>
    â”‚  <span class="highlight-yellow">  "displayName": "Groq",</span>
    â”‚  <span class="highlight-yellow">  "api_format": "openai",</span>
    â”‚  <span class="highlight-yellow">  "api_endpoint": "https://api.groq.com/openai",</span>
    â”‚  <span class="highlight-yellow">  "default_model": "llama-3.1-70b-versatile"</span>
    â”‚  <span class="highlight-yellow">}</span>
    â”‚
    â–¼
<span class="highlight-green">vendor_registry_controller.py</span>
    â”‚
    â”‚  _populate_vendor_credentials()
    â”‚  â””â”€â”€ Reads api_format, api_endpoint, default_model from metadata
    â”‚
    â–¼
<span class="highlight-purple">api.service.provider</span> (Database records)
    â”‚
    â”‚  Created with correct api_format for routing
    â”‚
    â–¼
<span class="highlight-blue">ai_brain.py</span>
    â”‚
    â”‚  send_message_streaming()
    â”‚  â””â”€â”€ Routes based on config.api_format
    â”‚      â”œâ”€â”€ 'openai' â†’ _chat_via_http()
    â”‚      â””â”€â”€ 'anthropic' â†’ _chat_via_sdk()
                </div>
            </div>

            <div class="flow-diagram" style="margin-top: 30px;">
                <div class="flow-title">Cost Comparison</div>
                <div class="ascii-diagram">
<span class="highlight-orange">COST PER MILLION TOKENS</span>

<span class="highlight-purple">Anthropic (Claude)</span>    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  $15-75
<span class="highlight-blue">OpenAI (GPT-4)</span>        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            $10-30
<span class="highlight-green">Groq (Llama)</span>          â–ˆ                                         $0.05-0.27
<span class="highlight-cyan">Ollama (Local)</span>        <span class="highlight-yellow">FREE</span>                                      $0.00

<span class="highlight-yellow">Use Case Recommendations:</span>
â”œâ”€â”€ Development/Testing:  <span class="highlight-green">Groq</span> (nearly free, very fast)
â”œâ”€â”€ Privacy-sensitive:    <span class="highlight-cyan">Ollama</span> (100% local, your hardware)
â”œâ”€â”€ Enterprise customers: <span class="highlight-blue">Let THEM choose</span> (their API key)
â””â”€â”€ Maximum quality:      <span class="highlight-purple">Anthropic/OpenAI</span> (customer pays)
                </div>
            </div>
        </div>

        <!-- ML LAYER SECTION (Phase 16) -->
        <div id="ml-layer" class="section">
            <div class="flow-diagram">
                <div class="flow-title">Phase 16: ML-Powered Personalization</div>
                <div class="ascii-diagram">
<span class="highlight-cyan">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-cyan">â”‚                         ML LAYER (Optional - Graceful Degradation)               â”‚</span>
<span class="highlight-cyan">â”‚                                                                                  â”‚</span>
<span class="highlight-cyan">â”‚   SAM works perfectly WITHOUT this layer - it just enables personalization       â”‚</span>
<span class="highlight-cyan">â”‚                                                                                  â”‚</span>
<span class="highlight-cyan">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                        SCIKIT-LEARN (Optional)                          â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                                                                         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  â”‚  TF-IDF         â”‚  â”‚  KMeans         â”‚  â”‚  Classification â”‚         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  â”‚  Vectorizer     â”‚  â”‚  Clustering     â”‚  â”‚  (Style)        â”‚         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  â”‚ Text â†’ Numbers  â”‚  â”‚ Group by Topic  â”‚  â”‚ Detect Patterns â”‚         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚                    â”‚                    â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                                â”‚                                        â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                                â–¼                                        â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚        ML INSIGHTS (if available)       â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚                                         â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚  â€¢ User prefers bullet points           â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚  â€¢ Technical vocabulary detected        â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚  â€¢ Recurring topic: "sales automation"  â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â”‚  â€¢ Communication style: concise         â”‚                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                                 â”‚                                       â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span>
<span class="highlight-cyan">â”‚                                    â”‚                                            â”‚</span>
<span class="highlight-cyan">â”‚                                    â–¼                                            â”‚</span>
<span class="highlight-cyan">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                     sam_voice.py (THE GUARDRAIL)                         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                                                                         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  <span class="highlight-green">âœ“ ALLOWED:</span>                                                            â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ Silent adaptation (just DO it, don't announce)                    â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ Match communication style                                         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ Provide deeper context on recurring topics                        â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚                                                                         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚  <span class="highlight-red">âœ— FORBIDDEN (CREEPY):</span>                                                  â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ "I noticed you work late on Thursdays..."                         â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ "Based on your emotional patterns..."                             â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ "Your productivity seems lower today..."                          â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â”‚    â€¢ "I've been tracking your response times..."                       â”‚    â”‚</span>
<span class="highlight-cyan">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span>
<span class="highlight-cyan">â”‚                                    â”‚                                            â”‚</span>
<span class="highlight-cyan">â”‚                                    â–¼                                            â”‚</span>
<span class="highlight-cyan">â”‚                          ai_brain.py (THE BRAIN)                                â”‚</span>
<span class="highlight-cyan">â”‚                          ML insights filtered through sam_voice                 â”‚</span>
<span class="highlight-cyan">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Graceful Degradation Pattern</div>
                <div class="ascii-diagram">
<span class="highlight-yellow">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-yellow">â”‚                          GRACEFUL DEGRADATION                                    â”‚</span>
<span class="highlight-yellow">â”‚                                                                                  â”‚</span>
<span class="highlight-yellow">â”‚   <span class="highlight-green">WITH ML (scikit-learn installed):</span>                                             â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ Topic clustering works                                                    â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ Style detection works                                                     â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ Response optimization works                                               â”‚</span>
<span class="highlight-yellow">â”‚   â””â”€â”€ SAM becomes more personalized over time                                   â”‚</span>
<span class="highlight-yellow">â”‚                                                                                  â”‚</span>
<span class="highlight-yellow">â”‚   <span class="highlight-blue">WITHOUT ML (scikit-learn NOT installed):</span>                                       â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ All core features work normally                                           â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ Chat works                                                                â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ Streaming works                                                           â”‚</span>
<span class="highlight-yellow">â”‚   â”œâ”€â”€ Memory works (if chromadb installed)                                      â”‚</span>
<span class="highlight-yellow">â”‚   â””â”€â”€ SAM just doesn't learn patterns                                           â”‚</span>
<span class="highlight-yellow">â”‚                                                                                  â”‚</span>
<span class="highlight-yellow">â”‚   <span class="highlight-purple">Code Pattern:</span>                                                                  â”‚</span>
<span class="highlight-yellow">â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚  try:                                                                   â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚      from sklearn.feature_extraction.text import TfidfVectorizer       â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚      from sklearn.cluster import KMeans                                â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚      <span class="highlight-green">ML_AVAILABLE = True</span>                                                 â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚  except ImportError:                                                   â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚      <span class="highlight-orange">ML_AVAILABLE = False</span>                                                â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â”‚      _logger.info("ML features disabled - SAM works normally")         â”‚   â”‚</span>
<span class="highlight-yellow">â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>
<span class="highlight-yellow">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
                </div>
            </div>

            <div class="component-grid">
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-service">ğŸ­</div>
                        <div class="component-name">sam_voice.py</div>
                        <div class="component-model">THE GUARDRAIL</div>
                    </div>
                    <div class="component-desc">
                        Filters what SAM can say about users. Contains FORBIDDEN_PHRASES list.
                        Renamed from sam_behavior.py in Phase 16.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">Key Responsibilities</div>
                        <div class="method-list">
                            <div class="method-item">
                                <span class="method-name">get_memory_enhanced_prompt()</span>
                                <span class="method-desc">Build prompts with memory context</span>
                            </div>
                            <div class="method-item">
                                <span class="method-name">format_memory_context()</span>
                                <span class="method-desc">Format past conversations</span>
                            </div>
                            <div class="method-item">
                                <span class="method-name">FORBIDDEN_PHRASES</span>
                                <span class="method-desc">List of creepy phrases to block</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-header">
                        <div class="component-icon layer-model">ğŸ¤–</div>
                        <div class="component-name">scikit-learn</div>
                        <div class="component-model">OPTIONAL</div>
                    </div>
                    <div class="component-desc">
                        Machine Learning library for pattern recognition. SAM works without it.
                    </div>
                    <div class="component-connections">
                        <div class="connection-label">ML Capabilities</div>
                        <div class="method-list">
                            <div class="method-item">
                                <span class="method-name">TfidfVectorizer</span>
                                <span class="method-desc">Convert text to numerical features</span>
                            </div>
                            <div class="method-item">
                                <span class="method-name">KMeans</span>
                                <span class="method-desc">Cluster conversations by topic</span>
                            </div>
                            <div class="method-item">
                                <span class="method-name">Classification</span>
                                <span class="method-desc">Detect communication styles</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">ML Feature Benefits</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>ML Technique</th>
                            <th>User Benefit</th>
                            <th>Privacy Note</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Topic Clustering</strong></td>
                            <td><code>KMeans + TF-IDF</code></td>
                            <td>SAM provides deeper context on recurring topics</td>
                            <td>Silent - no announcements</td>
                        </tr>
                        <tr>
                            <td><strong>Style Detection</strong></td>
                            <td><code>Text Classification</code></td>
                            <td>Matches user's preferred communication style</td>
                            <td>Adapts without saying "I noticed..."</td>
                        </tr>
                        <tr>
                            <td><strong>Response Optimization</strong></td>
                            <td><code>Pattern Analysis</code></td>
                            <td>Learns optimal response length/format</td>
                            <td>Just adjusts, never comments on it</td>
                        </tr>
                        <tr>
                            <td><strong>Vocabulary Enhancement</strong></td>
                            <td><code>TF-IDF + Frequency</code></td>
                            <td>Uses user's domain-specific terms</td>
                            <td>Mirrors language naturally</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flow-diagram">
                <div class="flow-title">Philosophy: Helpful vs Creepy</div>
                <div class="ascii-diagram">
<span class="highlight-green">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-green">â”‚                           HELPFUL (Do This)                                      â”‚</span>
<span class="highlight-green">â”‚                                                                                  â”‚</span>
<span class="highlight-green">â”‚  User asks about "sales pipelines" frequently                                   â”‚</span>
<span class="highlight-green">â”‚  â””â”€â–º SAM provides more depth on sales topics without being asked                â”‚</span>
<span class="highlight-green">â”‚                                                                                  â”‚</span>
<span class="highlight-green">â”‚  User prefers bullet points                                                     â”‚</span>
<span class="highlight-green">â”‚  â””â”€â–º SAM uses bullet points more often (silently adapts)                        â”‚</span>
<span class="highlight-green">â”‚                                                                                  â”‚</span>
<span class="highlight-green">â”‚  User is technical                                                              â”‚</span>
<span class="highlight-green">â”‚  â””â”€â–º SAM skips basic explanations (without saying "I know you're technical")    â”‚</span>
<span class="highlight-green">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="highlight-red">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="highlight-red">â”‚                           CREEPY (Never Do This)                                 â”‚</span>
<span class="highlight-red">â”‚                                                                                  â”‚</span>
<span class="highlight-red">â”‚  âœ— "I noticed you always work late on Thursdays..."                             â”‚</span>
<span class="highlight-red">â”‚  âœ— "Based on your emotional patterns, you seem stressed today..."               â”‚</span>
<span class="highlight-red">â”‚  âœ— "Your productivity seems lower than usual..."                                â”‚</span>
<span class="highlight-red">â”‚  âœ— "I've been tracking your response times and..."                              â”‚</span>
<span class="highlight-red">â”‚  âœ— "You've asked about [topic] 47 times this month..."                          â”‚</span>
<span class="highlight-red">â”‚  âœ— "I've observed that you..."                                                  â”‚</span>
<span class="highlight-red">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="highlight-yellow">The difference: HELPFUL adapts silently. CREEPY announces its surveillance.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
